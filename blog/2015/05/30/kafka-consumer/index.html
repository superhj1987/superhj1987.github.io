
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!-->
<html class="no-js" lang="zh-CN"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>kafka学习笔记 - Consumer开发的一些关键点 - 后端技术杂谈</title>
  <meta name="author" content="Mr.RowKey">
  <!--[if lt IE 9]>
    <script src="http://x.papaapp.com/farm1/a571d2/8dda131d/html5shiv.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.7/es5-sham.min.js"></script>
    <![endif]-->
  
  <meta name="description" content="Kafka学习笔记 - Consumer开发的一些关键点 Posted by Mr.RowKey in kafka Kafka的consumer是以pull的形式获取消息数据的。不同于队列和发布-订阅模式，kafka采用了consumer group的模式。通常的， &hellip;">
  

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.rowkey.me/blog/2015/05/30/kafka-consumer/">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <!-- <script src="http://cdn.staticfile.org/jquery/1.9.1/jquery.min.js"></script> -->
  <script src="//cdn.staticfile.org/jquery/2.0.3/jquery.min.js"></script>
  <link href="/atom.xml" rel="alternate" title="后端技术杂谈" type="application/atom+xml">
  <script data-ad-client="ca-pub-8736325488820874" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link rel="stylesheet" href="/stylesheets/comment.css">
<link rel="stylesheet" href="//cdn.staticfile.org/highlight.js/9.10.0/styles/default.min.css">
<style type="text/css">
  span#cnzz_stat_icon_1257166229{
  	display: none !important
  }
  .btn_primary{
    color: #fff;
    background-color: #006dcc;
    background-image: linear-gradient(to bottom,#08c,#04c);
    border-color: rgba(0,0,0,.1) rgba(0,0,0,.1) rgba(0,0,0,.25);
    padding: 4px 12px;
    margin-bottom: 0;
    font-size: 14px;
    line-height: 20px;
    vertical-align: middle;
    cursor: pointer;
    border-radius: 4px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.2), 0 1px 2px rgba(0,0,0,.05);
    display: inline-block;
    text-align: center;
  }
  #recent-comments .comment-widget-content {
      color: #000000 !important;
  }
</style>

  

</head>
<body   >
  <header id="header" class="clearfix">    <!-- cnzz统计 -->
    <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1257166229'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1257166229%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                <a id="logo" href="/">
                   后端技术杂谈
                </a>
                <p class="description">What、Why、How</p>
            </div>
            <div id="m-search">
                <section class="widget">
    <form action="http://cn.bing.com/search" method="get" target="_blank" onsubmit="return doSearch(this)">
    <div class="content">
      <input type="text" class="textfield searchtip" name="s" placeholder="请输入关键字" size="24" value="">
    </div>
    </form>
    <form action="http://cn.bing.com/search" method="get" target="_blank" style="display:none" name="frmSearch">
    <div class="content">
      <input type="hidden" name="q" value="">
    </div>
    </form>
</section>
<script type="text/javascript">
  function doSearch(o){
    var $s = $(o).find("input[name=s]");
    var $q = $(o).next("form").find("input[name=q]");
    $q.val($s.val() + " site:rowkey.me");
    $(o).next("form").submit();
    return false;
  }
</script>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="index-nav current" href="/">首页</a>
<a class="talks-nav" href="/blog/talks">技术琐话</a>
<a class="manage-nav" href="/blog/categories/genai">GenAI</a>
<a class="manage-nav" href="/blog/categories/manage">管理</a>
<a class="architecture-nav" href="/blog/categories/architecture">架构</a>
<a class="java-nav" href="/blog/categories/java">Java</a>
<a class="categories-nav" href="/blog/categories">分类</a>
<a class="archives-nav" href="/blog/archives">归档</a>
<a class="about-nav" href="/about_me.html">关于</a>
                </nav>
            </div>
        </div>
    </div>
</header>
  <div id="body">
    <div class="container">
    	<div class="col-group">
			<div class="col-8" id="main">
  <div class="res-cons">
  <article class="post clearfix">
  
  <header>
    
      <h1 class="post-title">Kafka学习笔记 - Consumer开发的一些关键点</h1>
    
    
      <p class="post-meta">
        








  


<time datetime="2015-05-30T22:00:18+08:00" pubdate data-updated="true"></time>
        
        
  

<span class="byline author vcard">Posted by <span class="fn">Mr.RowKey</span></span>
 in 

<span class="categories">
  
    <a class='category' href='/blog/categories/kafka/'>kafka</a>
  
</span>


        
      </p>
    
  </header>


<div class="post-content"><p>Kafka的consumer是以pull的形式获取消息数据的。不同于队列和发布-订阅模式，kafka采用了consumer group的模式。通常的，一般采用一个consumer中的一个group对应一个业务，配合多个producer提供数据。</p>

<p><img src="/images/blog_images/kafka-consumer.jpg" alt="pic" /></p>

<h2>一. 消费过的数据无法再次消费</h2>

<p>在user level上，一旦消费过topic里的数据，那么就无法再次用同一个groupid消费同一组数据。如果想要再次消费数据，要么换另一个groupid，要么使用镜像：</p>

<p><img src="/images/blog_images/kafka-consumer-1.jpg" alt="pic" /></p>

<p>此外，low level的api提供了一些机制去设置partion和offset。</p>

<h2>二. offset管理</h2>

<p>kafka会记录offset到zk中。但是，zk client api对zk的频繁写入是一个低效的操作。0.8.2 kafka引入了native offset storage，将offset管理从zk移出，并且可以做到水平扩展。其原理就是利用了kafka的compacted topic，offset以consumer group,topic与partion的组合作为key直接提交到compacted topic中。同时Kafka又在内存中维护了<consumer group,topic,partition>的三元组来维护最新的offset信息，consumer来取最新offset信息的时候直接内存里拿即可。当然，kafka允许你快速的checkpoint最新的offset信息到磁盘上。</p>

<h2>三. stream</h2>

<p>This API is centered around iterators, implemented by the KafkaStream class. Each KafkaStream represents the stream of messages from one or more partitions on one or more servers. Each stream is used for single threaded processing, so the client can provide the number of desired streams in the create call. Thus a stream may represent the merging of multiple server partitions (to correspond to the number of processing threads), but each partition only goes to one stream.</p>

<p>根据官方文档所说，stream即指的是来自一个或多个服务器上的一个或者多个partition的消息。每一个stream都对应一个单线程处理。因此，client能够设置满足自己需求的stream数目。总之，一个stream也许代表了多个服务器partion的消息的聚合，但是每一个partition都只能到一个stream。</p>

<h2>四. consumer和partition</h2>

<ol>
<li>如果consumer比partition多，是浪费，因为kafka的设计是在一个partition上是不允许并发的，所以consumer数不要大于partition数</li>
<li>如果consumer比partition少，一个consumer会对应于多个partitions，这里主要合理分配consumer数和partition数，否则会导致partition里面的数据被取的不均匀</li>
<li>如果consumer从多个partition读到数据，不保证数据间的顺序性，kafka只保证在一个partition上数据是有序的，但多个partition，根据你读的顺序会有不同</li>
<li>增减consumer，broker，partition会导致rebalance，所以rebalance后consumer对应的partition会发生变化</li>
<li>High-level接口中获取不到数据的时候是会block的</li>
</ol>


<p>负载低的情况下可以每个线程消费多个partition。但负载高的情况下，Consumer 线程数最好和Partition数量保持一致。如果还是消费不过来，应该在增加partition数的同时增加consumer数或者通过某些手段提升消息处理能力。需要注意的是，由于Kafka主要是磁盘读写，Partition的增多如果是单个磁盘那么在并发性能上会有瓶颈,可以通过增加磁盘来扩展并发能力。</p>

<h2>五. high-level的consumer工具</h2>

<ol>
<li><p>bin/kafka-run-class.sh kafka.tools.ConsumerOffsetChecker &ndash;group pv</p>

<p> 可以看到当前group offset的状况。</p></li>
<li><p>bin/kafka-run-class.sh kafka.tools.UpdateOffsetsInZK earliest config/consumer.properties  page_visits</p>

<pre><code> 3个参数， 
 [earliest | latest]，表示将offset置到哪里 
 consumer.properties ，这里是配置文件的路径 
 topic，topic名，这里是page_visits
</code></pre></li>
</ol>


<h2>六. SimpleConsumer</h2>

<p>kafka的low-level接口，使用场景：</p>

<ol>
<li>读取一个消息多次。</li>
<li>在一个进程中仅仅消费某一个topic中几个partition的数据.</li>
<li>管理事务以确保一个消息处理且仅仅被处理一次。</li>
</ol>


<p>用这个接口需要注意一下几点：</p>

<ol>
<li>在应用中必须跟踪记录offset以确保能够确定上次消费到的位置。</li>
<li>必须设置哪一个broker是要操作的topic和partition的leader。</li>
<li>必须自己控制broker的leader的改变。</li>
</ol>


<p>使用步骤：</p>

<ol>
<li>找出一个active状态的broker并且找出哪一个broker是那些topic和partition的leader，必须知道读哪个topic的哪个partition。</li>
<li>找到负责该partition的broker leader，从而找到存有该partition副本的那个broker。</li>
<li>自己去写request并fetch数据。</li>
<li>获取数据。</li>
<li>需要识别和处理broker leader的改变。</li>
</ol>

</div>
<!-- <div style="width:100%;text-align:center;display: none" id="wxFooter">
  <img src="/images/blog_images/h.png"/>
  <p style="color: rgb(58, 65, 69);"><strong>ID: servertalk</strong></p>
  <img src="/images/blog_images/mp-qrcode.jpg"/>
  <p style="color: rgb(178, 178, 178);"><strong>关注[<span style="color:red !important;">后端技术杂谈</span>]</strong></p>
  <p style="color: rgb(178, 178, 178);"><strong>把握后端技术</strong></p>
</div>
<script>
var browser = {
  versions: function () {
      var u = navigator.userAgent, app = navigator.appVersion;
      return {         //移动终端浏览器版本信息
          trident: u.indexOf('Trident') > -1, //IE内核
          presto: u.indexOf('Presto') > -1, //opera内核
          webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
          gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
          mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
          ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
          android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或uc浏览器
          iPhone: u.indexOf('iPhone') > -1, //是否为iPhone或者QQHD浏览器
          iPad: u.indexOf('iPad') > -1, //是否iPad
          webApp: u.indexOf('Safari') == -1 //是否web应该程序，没有头部与底部
      };
  }(),
  language: (navigator.browserLanguage || navigator.language).toLowerCase()
}
if (browser.versions.mobile) {//判断是否是移动设备打开。browser代码在下面
  // var ua = navigator.userAgent.toLowerCase();//获取判断用的对象
  // if (ua.match(/MicroMessenger/i) == "micromessenger") {
  $("div#wxFooter").show();
  // }
  // if (ua.match(/WeiBo/i) == "weibo") {
  //         //在新浪微博客户端打开
  // }
  // if (ua.match(/QQ/i) == "qq") {
  //         //在QQ空间打开
  // }
  // if (browser.versions.ios) {
  //         //是否在IOS浏览器打开
  // } 
  // if(browser.versions.android){
  //         //是否在安卓浏览器打开
  // }
} 
</script> -->


  <div class="_dj8d8fo8gk" style="display:none"></div>
  <div class="_ywga8i2zs8c"></div>
  <footer class="post-footer">
    
      <!-- <div class="sharing">
  
  
  
</div>
 -->
 <div class="share"  style='margin-bottom:15px'>

</div>

    
    <div class="meta">
      
        <a class="basic-alignment left" style="float:left !important" href="/blog/2015/06/10/hbase-about/" title="上一篇: Hbase关键的几个点">&laquo; Hbase关键的几个点 </a>
      
      
        <a class="basic-alignment right" style="float:right !important" href="/blog/2015/05/30/kafka-usage/" title="下一篇: kafka学习笔记 - 使用与配置">kafka学习笔记 - 使用与配置 &raquo;</a>
      
    </div>
  </footer>
</article>


<h2>评论</h2>
<div id="comment-thread"></div>

  </div>
</div>

  <aside id="secondary">
  <div id="sidebar">
  
    <section class="widget" style="font-size:9pt" id="ads">
    <div class="_azq7d9qhrfo"></div>
</section><section class="widget" style="font-size:9pt" id="copyright">
<p><span style="font-weight:bold">版权声明：</span>本博客所有文章为博主原创或翻译文章，采用<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享署名-非商业性使用-相同方式共享4.0</a> 国际许可协议共享，转载请注明作者和原文链接。</p>
</section><section class="widget">
    <form action="http://cn.bing.com/search" method="get" target="_blank" onsubmit="return doSearch(this)">
    <div class="content">
      <input type="text" class="textfield searchtip" name="s" placeholder="请输入关键字" size="24" value="">
    </div>
    </form>
    <form action="http://cn.bing.com/search" method="get" target="_blank" style="display:none" name="frmSearch">
    <div class="content">
      <input type="hidden" name="q" value="">
    </div>
    </form>
</section>
<script type="text/javascript">
  function doSearch(o){
    var $s = $(o).find("input[name=s]");
    var $q = $(o).next("form").find("input[name=q]");
    $q.val($s.val() + " site:rowkey.me");
    $(o).next("form").submit();
    return false;
  }
</script><!--公告-->
<section class="widget" id="notice">
	<p><a href="https://tech.wekoi.cn/" target="_blank">微鲤技术团队</a>长期求各研发职位，感兴趣者可发送简历到<a href="mailto:hang@wekoi.cn">hang@wekoi.cn</a>。</p>
	<div style="margin-bottom: 10px">
	原博客：<a href="http://srhang.iteye.com/" target="_blank">http://srhang.iteye.com/</a>
	</div>
</section><section class="widget" id="social">
		
		<a class="weibo" href="http://weibo.com/superhj1987" title="Weibo" target="_blank">Weibo</a>
		
		
			<a class="github" href="https://github.com/superhj1987" title="GitHub" target="_blank">GitHub</a>
		
		
		
		<!-- 
			<a class="linkedin" href="http://www.linkedin.com/in/superhj1987" title="LinkedIn" target="_blank">LinkedIn</a>
		 -->
		
		
		
		
		
		
    	
    	
			<a class="rss" href="/atom.xml" title="RSS" target="_blank">RSS</a>
		
</section><section class="widget">
	<h3 class="widget-title">最新文章</h3>
	<ul class="widget-list">
		
     	<li>
      	  <a href="/blog/2024/02/01/ai-best-practice/">AI技术概览（PPT版）</a>
      	</li>
    	
     	<li>
      	  <a href="/blog/2023/11/30/openai-func/">Langchain代理和OpenAI函数调用的区别</a>
      	</li>
    	
     	<li>
      	  <a href="/blog/2023/07/30/build-gpt-chatbot/">【译】如何基于开源技术构建类似ChatGPT的聊天机器人</a>
      	</li>
    	
     	<li>
      	  <a href="/blog/2023/05/29/web3/">Web3学习笔记-Web3是什么？</a>
      	</li>
    	
     	<li>
      	  <a href="/blog/2022/06/04/arch-usage/">架构简明指南2022最新版</a>
      	</li>
    	
     	<li>
      	  <a href="/blog/2022/05/04/article-notes/">阅文笔记202205</a>
      	</li>
    	
     	<li>
      	  <a href="/blog/2022/02/13/my2021/">我的2021</a>
      	</li>
    	
     	<li>
      	  <a href="/blog/2021/08/13/game/">做游戏业务以来的一些感悟</a>
      	</li>
    	
     	<li>
      	  <a href="/blog/2021/03/31/ali-manage/">阿里巴巴管理三板斧</a>
      	</li>
    	
     	<li>
      	  <a href="/blog/2021/01/13/my2020/">我的2020</a>
      	</li>
    	
	</ul>
</section>
<section class="widget" style="margin-bottom: 0px !important">
	<h3 class="widget-title">最新评论</h3>
	<div id="recent-comments">暂无</div>
</section>


<section>
  <h3 class="widget-title">GitHub Repos</h3>
  <ul id="gh_repos" class="widget-list">
    <li class="loading">数据读取中...</li>
  </ul>
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'superhj1987',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section class="widget">
	<h3 class="widget-title">技术酷站</h3>
	<ul class="widget-list">
		<li><a href="https://tech.wekoi.cn/" target="_blank">微鲤技术团队</a></li>
     	<li><a href="http://toutiao.io/" target="_blank">开发者头条</a></li>
     	<li><a href="https://dzone.com/java-jdk-development-tutorials-tools-news" target="_blank">DZone - Java Zone</a></li>
		<li><a href="http://ifeve.com/" target="_blank">并发编程网</a></li>
	</ul>
</section>
  
  </div>
</aside>


      	</div>
    </div>
  </div>
  <footer id="footer">
  	<div class="container">
	Copyright &copy; 2024 - Mr.RowKey - 京ICP备20027460号 -
  <span class="credit">Powered by <a rel="nofollow" href="http://octopress.org">Octopress</a></span>
  - <span class="credit">Theme by <a rel="nofollow" href="http://pagecho.com">Cho</a></span>


</div>
<link href="/stylesheets/scrollUp.min.css" media="screen, projection" rel="stylesheet" type="text/css">
<script type="text/javascript" src="/javascripts/libs/jquery.scrollUp.min.js"></script>
<script src="//cdn.staticfile.org/marked/0.3.6/marked.min.js"></script>
<script src="//cdn.staticfile.org/timeago.js/3.0.1/timeago.min.js"></script>
<script src="//cdn.staticfile.org/spin.js/2.3.2/spin.min.js"></script>
<script src="//cdn.staticfile.org/highlight.js/9.10.0/highlight.min.js"></script>
<script type="text/javascript">
  marked.setOptions({
  highlight: function (code, lang) {
     return hljs.highlightAuto(code).value;
  }
  });
  function Highlighting(){
    var markdowns = document.getElementsByClassName('markdown');
    for(var i=0;i<markdowns.length;i++){
       if(markdowns[i].innerHTML) markdowns[i].innerHTML =marked(markdowns[i].innerHTML);
    }
  }
  window.addEventListener('DOMContentLoaded', Highlighting, false);
  window.addEventListener('load', Highlighting, false);
</script>
<script src="/javascripts/comment.js"></script>
<script type="text/javascript">
$(function(){
	$.scrollUp({
		appendId: 'footer'
	});
});
var opt = {
   type: "github",
   user: "superhj1987",
   repo: "superhj1987.github.io",
   no_comment: "还没有评论",
   go_to_comment: "点击评论",
   issue_title: "kafka学习笔记 - Consumer开发的一些关键点",
   btn_class: "btn_primary",
   comments_target: "#comment-thread",
   loading_target: "#loading-spin",
   client_id: "",
   client_secret: ""
};
getComments(opt);
opt = {
   type: "github",
   user: "superhj1987",
   repo: "superhj1987.github.io",
   recent_comments_target: "#recent-comments",
   count: 5,
   client_id: "",
   client_secret: ""
};
getRecentCommentsList(opt);
</script>
<script type="text/javascript">
   (window.slotbydup = window.slotbydup || []).push({
       id: "u6803601",
       container: "_azq7d9qhrfo",
       async: true
   });
   (window.slotbydup = window.slotbydup || []).push({
       id: "u6803483",
       container: "_ywga8i2zs8c",
       async: true
   });
   (window.slotbydup = window.slotbydup || []).push({
       id: "u6803481",
       container: "_dj8d8fo8gk",
       async: true
   });
</script>
<!-- 多条广告如下脚本只需引入一次 -->
<script type="text/javascript" src="//cpro.baidustatic.com/cpro/ui/cm.js" async="async" defer="defer" >
</script>
  </footer>
  











</body>
</html>
